#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
VENV_DIR="${SCRIPT_DIR}/.venv"
PYTHON_BIN="${VENV_DIR}/bin/python"

if [[ -f "${REPO_ROOT}/.env" ]]; then
  set -a
  # .env file may not exist or be user-created
  # shellcheck disable=SC1090,SC1091
  source "${REPO_ROOT}/.env"
  set +a
fi

if [[ ! -x "${PYTHON_BIN}" ]]; then
  echo "Creating virtualenv at ${VENV_DIR}..." >&2
  python3 -m venv "${VENV_DIR}"
  "${PYTHON_BIN}" -m pip install --upgrade pip >/dev/null
  "${PYTHON_BIN}" -m pip install -r "${REPO_ROOT}/requirements.txt"
fi

exec "${PYTHON_BIN}" "${SCRIPT_DIR}/ssm-get.py" "$@"
